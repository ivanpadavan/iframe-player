"use strict";(self.webpackChunkiframe_player=self.webpackChunkiframe_player||[]).push([[624],{5624:(V,D,s)=>{s.r(D),s.d(D,{WebosPlayer:()=>me});var R=s(467),b=s(2771),w=s(8839),U=s(8793),y=s(6697),p=s(3557),A=s(3703),l=s(3028),g=s(8750);function h(i,e){return e?t=>(0,U.x)(e.pipe((0,y.s)(1),(0,p.w)()),t.pipe(h(i))):(0,l.Z)((t,n)=>(0,g.Tg)(i(t,n)).pipe((0,y.s)(1),(0,A.u)(t)))}var m=s(1807);function C(i,e=w.E){const t=(0,m.O)(i,e);return h(()=>t)}var v=s(3726),N=s(6977),P=s(5964),B=s(5755),a=s(8970),O=s(1880),J=s(1985);const W="luna://com.webos.service.drm";function $(i,e){return new Promise((t,n)=>{let r;(0,a.Wz)(`[DRM][REQUEST][${i}]`,e);const o=window.webOS.service.request(W,{method:i,parameters:e,onSuccess:d=>{(0,a.Wz)("[DRM][RESPONSE] ",d),clearTimeout(r),t(d)},onFailure:d=>{(0,a.Wz)("[DRM][ERROR]",d),clearTimeout(r),n(d)}});r=setTimeout(()=>{(0,a.Wz)("[DRM][TIMEOUT]"),o.cancel(),n({errorCode:-1,errorText:"timeout"})},1e4)})}var f=function(i){return i.LOAD="load",i.UNLOAD="unload",i.IS_LOADED="isLoaded",i.SEND_DRM_MESSAGE="sendDrmMessage",i.GET_RIGHTS_ERROR="getRightsError",i}(f||{}),c=function(i){return i[i.NO_INIT=0]="NO_INIT",i[i.LOADING=1]="LOADING",i[i.READY=2]="READY",i[i.UNLOADING=3]="UNLOADING",i[i.ERROR=4]="ERROR",i}(c||{});class q{constructor(e,t,n){this.drmType=e,this.licenseServerUrl=t,this.unloadStrategy=n,this.state=c.NO_INIT,this.eventListeners=new Set,this.activePlayerIds=new Set}registerPlayer(e){this.activePlayerIds.add(e),this.unloadStrategy.onRegisterPlayer(e,this.activePlayerIds.size)}unregisterPlayer(e){this.activePlayerIds.delete(e),this.unloadStrategy.onUnregisterPlayer(e,this.activePlayerIds.size)}addEventListener(e){this.eventListeners.add(e)}removeEventListener(e){this.eventListeners.delete(e)}load(){var e=this;return(0,R.A)(function*(){if(e.clientId)(0,a.Wz)("DRM \u043a\u043b\u0438\u0435\u043d\u0442 \u0443\u0436\u0435 \u0431\u044b\u043b \u0438\u043d\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d.");else if(e.state!==c.LOADING)if(e.state!==c.UNLOADING){e.state=c.LOADING;try{const t=yield $(f.LOAD,{appId:window.webOS.fetchAppId(),drmType:e.drmType});e.clientId=t.clientId,e.emitEvent({type:"drm_load"}),e.unloadStrategy.initDRM(e.unload.bind(e)),e.state=c.READY,"playready"===e.drmType&&e.subscribePlayReadyLicensingError(),yield function K(i){return new Promise(e=>setTimeout(e,i))}(1e3)}catch(t){e.handleError("DRM \u043a\u043b\u0438\u0435\u043d\u0442 \u043d\u0435 \u0441\u043c\u043e\u0433 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c\u0441\u044f",t.errorCode,t.errorText,!0),e.state=c.ERROR}}else(0,a.Yi)("DRM \u043a\u043b\u0438\u0435\u043d\u0442 \u0434\u0435\u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442\u0441\u044f");else(0,a.Yi)("DRM \u043a\u043b\u0438\u0435\u043d\u0442 \u0443\u0436\u0435 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442\u0441\u044f")})()}setContent(e){var t=this;return(0,R.A)(function*(){if(t.state===c.ERROR)throw new Error("DRM \u043a\u043b\u0438\u0435\u043d\u0442 \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f \u0432 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438 \u043e\u0448\u0438\u0431\u043a\u0438 - \u043d\u0435\u043b\u044c\u0437\u044f \u043d\u0438\u0447\u0435\u0433\u043e \u043f\u043e\u0441\u044b\u043b\u0430\u0442\u044c \u043d\u0430 \u0432\u043e\u0441\u043f\u0440\u043e\u0438\u0437\u0432\u0435\u0434\u0435\u043d\u0438\u0435");if(!t.clientId)throw new Error("DRM Client load content before init complete. Need wait complete init promise");let n,r,o;switch(t.drmType){case"playready":n="urn:dvb:casystemid:19219",r="application/vnd.ms-playready.initiator+xml",o=function Q(i){return`<?xml version="1.0" encoding="utf-8"?>\n        <PlayReadyInitiator xmlns="http://schemas.microsoft.com/DRM/2007/03/protocols/">\n            <LicenseServerUriOverride>\n                <LA_URL>${i.licenseServerUri}</LA_URL>\n            </LicenseServerUriOverride>\n        </PlayReadyInitiator>`}({licenseServerUri:t.licenseServerUrl});break;case"widevine":n="urn:dvb:casystemid:19156",r="application/widevine+xml",o=function j(i){return`<?xml version="1.0" encoding="utf-8"?>\n    <WidevineCredentialsInfo xmlns="http://www.smarttv-alliance.org/DRM/widevine/2012/protocols/" >\n      <ContentURL></ContentURL>\n      <DeviceID>${i.deviceID||""}</DeviceID>\n      <StreamID>${i.streamID||""}</StreamID>\n      <ClientIP>${i.clientIP||""}</ClientIP>\n      <DRMServerURL>${i.drmServerURL||""}</DRMServerURL>\n      <DRMAckServerURL>${i.drmAckServerURL||""}/DRMAckServerURL>\n      <DRMHeartBeatURL>${i.drmHeartBeatURL||""}</DRMHeartBeatURL>\n      <DRMHeartBeatPeriod>${i.drmHeartBeatPeriod||""}</DRMHeartBeatPeriod>\n      <UserData>${i.userData||""}</UserData>\n      <Portal>${i.portal||""}</Portal>\n      <StoreFront>${i.storeFront||""}</StoreFront>\n      <BandwidthCheckURL>${i.bandwidthCheckURL||""}</BandwidthCheckURL>\n      <BandwidthCheckInterval>${i.bandwidthCheckInterval||""}</BandwidthCheckInterval>\n    </WidevineCredentialsInfo >`}({contentURL:e,drmServerURL:t.licenseServerUrl})}try{yield $(f.SEND_DRM_MESSAGE,{clientId:t.clientId,msgType:r,drmSystemId:n,msg:o})}catch(d){t.handleError("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 sendDrmMessage",d.errorCode,d.errorText)}})()}unload(){var e=this;return(0,R.A)(function*(){if(e.state===c.READY)try{e.state=c.UNLOADING,e.getRightsErrorSub&&(e.getRightsErrorSub.unsubscribe(),e.getRightsErrorSub=void 0),yield $(f.UNLOAD,{clientId:e.clientId}),e.emitEvent({type:"drm_unload"}),(0,a.Wz)(`DRM Client ${e.clientId} is unloaded successfully`),e.clientId=void 0,e.state=c.NO_INIT}catch(t){e.handleError(`DRM Client ${e.clientId} unload failed`,t.errorCode,t.errorText,!0)}})()}handleError(e,t,n,r=!1){(0,a.Yi)(e+" (["+t+"] "+n+")"),r&&(this.state=c.ERROR),this.emitEvent({type:"drm_error",criticalError:r,description:e,errorCode:t,errorText:n})}emitEvent(e){this.eventListeners.forEach(t=>{t(e)})}getRightsErrorHandler(e){let t="DRM System ID: "+e.drmSystemId+" | ";t+="License Server URL: "+e.rightIssueUrl,0==+e.errorState?t+="Error: No license":1==+e.errorState&&(t+="Error: Invalid license"),this.handleError(t,-1,"DRMRights Error",!1)}subscribePlayReadyLicensingError(){this.getRightsErrorSub=function X(i,e){return new J.c(t=>{(0,a.Wz)(`[DRM][SUBSCRIBE][${i}]`,e);const n=window.webOS.service.request(W,{method:i,parameters:e,subscribe:!0,onSuccess:r=>{(0,a.Wz)(`[DRM][SUBSCRIBE_RESPONSE][${i}]`,r),t.next(r)},onFailure:r=>{(0,a.Wz)(`[DRM][SUBSCRIBE_ERROR][${i}]`,r),t.error(r)}});t.add(()=>{(0,a.Wz)(`[DRM][SUBSCRIBE_COMPLETE][${i}]`),n.cancel()})})}(f.GET_RIGHTS_ERROR,{clientId:this.clientId,subscribe:!0}).subscribe(e=>{e.contentId?this.getRightsErrorHandler(e):e.subscribed&&(0,a.Wz)("\u0423\u0441\u043f\u0435\u0448\u043d\u043e \u043f\u043e\u0434\u043f\u0438\u0441\u0430\u043b\u0438\u0441\u044c \u043d\u0430 "+f.GET_RIGHTS_ERROR)},e=>{this.handleError("\u041e\u0448\u0438\u0431\u043a\u0430 "+f.GET_RIGHTS_ERROR,e.errorCode,e.errorText)})}}var L=function(i){return i.INSTANTLY="instantly",i.NO_DESTROY="no-destroy",i.SMART="smart",i}(L||{});class _{initDRM(e){this.unloadCallback=e}onRegisterPlayer(){}onUnregisterPlayer(e,t){0===t&&this.unloadCallback()}}class ee{initDRM(){}onRegisterPlayer(){}onUnregisterPlayer(){}}class re{initDRM(e){this.unloadCallback=e}onRegisterPlayer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0)}onUnregisterPlayer(e,t){0===t&&(this.timeoutId=setTimeout(()=>{this.unloadCallback()},6e4))}}class ne{constructor(){this.clients={}}getDrm(e,t,n){if(!this.clients[e]){const r=new q(e,t,function ie(i){switch(i){case L.INSTANTLY:return new _;case L.NO_DESTROY:return new ee;default:return new re}}(n));r.addEventListener(o=>{("drm_unload"===o.type||"drm_error"===o.type&&o.criticalError)&&this.clients[e]===r&&(this.clients[e]=void 0)}),this.clients[e]=r}return this.clients[e]}}var G=s(1413),I=s(8141),z=s(5558),k=s(5454),oe=s(983),de=s(7786),le=s(5985);const F=i=>(0,le.gB)(()=>i.end(0),NaN),Y=i=>{const{currentTime:e,buffered:t,duration:n,playData:r}=i;return{currentTime:e,bufferedUntil:F(t),duration:n,playData:r}},u=(...i)=>(0,a.Wz)("[WebOS network recovering]",...i);class ue{constructor(e){this.state=e,this.status="IDLE",this.startRecover$=new G.B}init(e){const t=d=>e.pipe((0,P.p)(M=>M.type===d)),n=t("initial_playing").pipe((0,I.M)(()=>{"FAIL"===this.status&&(this.status="IDLE")}),(0,p.w)()),r=new G.B,o=this.startRecover$.pipe((0,z.n)(()=>{const d=Y(this.state);this.status="RECOVERING",u("recovering step 1"),r.next({type:"set-play-data",playData:{...d.playData,startTime:d.currentTime}});const M=t("error").pipe((0,y.s)(1)),ve=t("progress").pipe((0,P.p)(()=>{const T=d.bufferedUntil,E=F(this.state.buffered),S=E>T;return S&&u("recovering succeed",{initialBufferedUntil:T,currentBufferedUntil:E}),S}),(0,y.s)(1),(0,I.M)(()=>{this.status="IDLE"}));return(0,k.O)(ve,M.pipe((0,z.n)(T=>{const E=d.bufferedUntil+4,S=(0,O.xw)(T)&&T.detail?.code!==MediaError.MEDIA_ERR_NETWORK,H=E>d.duration;return S||H?(S&&u("cannot recover dur to invalid second error. May be lack of internet thing"),H&&u(`cannot recover to ${E} because out of range ${d.duration}`),this.status="FAIL",oe.w):(u("recovering step 2"),r.next({type:"set-play-data",playData:{...d.playData,startTime:E}}),(0,k.O)(M.pipe((0,I.M)(()=>{u("recover step 2 failed"),this.status="FAIL"})),t("initial_playing").pipe((0,I.M)(()=>{u("recover step 2 succeed"),this.status="IDLE"}))))})))}),(0,p.w)());return(0,de.h)(n,o,r.pipe((0,I.M)(d=>u("command sent",d))))}recover(){const{currentTime:e,bufferedUntil:t,duration:n}=Y(this.state);return u("recovering requested while status is",this.status,{currentTime:e,bufferedUntil:t,duration:n}),"IDLE"===this.status&&0!==e&&0!==n&&t>=e?(this.startRecover$.next(),!0):"RECOVERING"===this.status?(u("recovering already in progress"),!0):(u("recovering declined"),!1)}}class fe extends B.O{constructor(e){super(e),this.type="streaming",this.manifestType="mpeg-dash"}get webosMediaElement(){return this.videoElement}getVideoTracks(){return[]}getAudioTracks(){return Array.from(this.webosMediaElement.audioTracks).map(e=>({active:e.enabled,id:e.id,label:e.label,language:e.language}))}get isLiveStream(){return void 0!==this.playData?.programType&&this.playData.programType!==a._N.catchUp}get liveStreamCurrentTime(){return this.availabilityStartTime&&this.currentTime?new Date(1e3*(+this.availabilityStartTime/1e3+this.currentTime)):null}get availabilityStartTime(){return this.currentTime?new Date(Date.now()-1e3*this.seekRange.end):null}get seekRange(){const e=this.videoElement.seekable;return e.length?{start:e.start(0),end:e.end(e.length-1)}:{start:0,end:0}}get currentManifest(){throw new Error("method not implemented")}get hasTimeShiftManifest(){throw new Error("method not implemented")}}const x={MEDIA_ERR_DECODE:0,SOURCE_ERR:0};class me extends B.N{constructor(){super(O.ap),this.type="streaming",this.errorsCounter={...x},this.uniqueId=function Re(){return"xxxx-xxxx-xxx-xxxx".replace(/x/g,()=>Math.floor(16*Math.random()).toString(16))}(),this.destroy$=new b.m(1),this.drmEventListener=e=>{this.handlePlayerVideoEvent(e)}}goToLive(){this.video.currentTime=this.video.seekable.end(0)-5}setAbrState(){(0,a.Wz)("Abr option always enabled")}addGlobalDebugger(){(0,a.Wz)("Add Global Debugger unavailable")}removeGlobalDebugger(){(0,a.Wz)("Remove Global Debugger unavailable")}init(e,t){var n=()=>super.init,r=this;return(0,R.A)(function*(){if(!r.isBrowserSupported())throw Error("\u0411\u0440\u0430\u0443\u0437\u0435\u0440 \u043d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 WebOS \u043f\u043b\u0435\u0435\u0440");if(!window.webOS)throw Error("\u0414\u043b\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u043f\u043b\u0435\u0435\u0440\u0430 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044f webOSTV.js");if(t.drm){const o=function se(){return window.DRMClientFactory||(window.DRMClientFactory=new ne),window.DRMClientFactory}();r.drm=o.getDrm(t.drm.drmType,t.drm.drmServerUrl,t.drm.drmUnloadStrategy),r.drm.registerPlayer(r.uniqueId),r.drm.addEventListener(r.drmEventListener),yield r.drm.load()}yield n().call(r,e,t),r.networkErrorProcedure=new ue(r.state),r.networkErrorProcedure.init(r.events$).pipe((0,N.Q)(r.destroy$)).subscribe(o=>{"set-play-data"===o.type&&r.load(o.playData)}),(0,a.Wz)("\u041f\u043b\u0435\u0435\u0440 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d"),r.events$.pipe((0,P.p)(o=>"playing"===o.type),C(1e3),(0,N.Q)(r.destroy$)).subscribe(()=>{r.errorsCounter={...x}})})()}initState(){this.state=new fe(this.video)}detach(){var e=()=>super.detach,t=this;return(0,R.A)(function*(){yield e().call(t),t.drm?.unregisterPlayer(t.uniqueId),t.drm?.removeEventListener(t.drmEventListener),t.destroy$.next()})()}isBrowserSupported(){return!!window.PalmSystem}load(e,t=!0){var n=()=>super.load,r=this;return(0,R.A)(function*(){yield n().call(r,e),t&&(r.errorsCounter={...x}),e.playUrl?((0,a.Wz)("\u041f\u043b\u0435\u0435\u0440 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430",{playData:e,resetErrorCounter:t,errorCounter:{...r.errorsCounter}}),r.applySourceAttributes(e.playUrl,r.getType(e.playUrl,e.startTime)),r.drm&&(yield r.drm.setContent(e.playUrl)),r.video.load(),r.afterLoad()):r.video.src&&((0,a.Wz)("\u041f\u043b\u0435\u0435\u0440 \u043e\u0447\u0438\u0441\u0442\u043a\u0430"),r.applySourceAttributes("",""),r.drm&&(yield r.drm.setContent("")))})()}selectTextTrack(e){Array.from(this.video.textTracks).forEach(t=>{t.mode=t.id===e?"showing":"disabled"})}selectVideoTrack(){}selectAudioTrack(e){const t=Array.from(this.state.webosMediaElement.audioTracks),n=t.find(r=>r.language===e);if(n)for(let r=0;r<t.length;r++)t[r].enabled=t[r].id===n.id;else(0,a.Wz)(`\u041f\u043e\u043f\u044b\u0442\u043a\u0430 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0437\u0432\u0443\u043a\u043e\u0432\u0443\u044e \u0434\u043e\u0440\u043e\u0436\u043a\u0443 \u0441 \u044f\u0437\u044b\u043a\u043e\u043c ${e}, \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b \u0442\u043e\u043b\u044c\u043a\u043e ${t.map(r=>r.language)}`)}setSubtitlesContainer(){}selectVariantByLabel(e){const t=Array.from(this.state.webosMediaElement.audioTracks),n=t.find(r=>r.label===e);n||(0,a.Yi)("\u043d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0432\u044b\u0431\u0440\u0430\u0442\u044c \u0430\u0443\u0434\u0438\u043e \u043f\u043e label:",e),t.forEach(r=>r.enabled=n===r)}setCurrentTimeInUTC(){throw new Error("method not implemented")}setListeners(){for(const e of this.eventsList)"error"!==e&&this.video.addEventListener(e,this.listener);this.video.addEventListener("error",()=>{this.videoErrorListener((0,O.BB)(this.video.error,this.video))})}restart(){return this.load({...this.state.playData,startTime:this.state.lastPlaybackTime},!1)}videoErrorListener(e){const{code:t}=e.detail,n=a.gM[t];switch(t){case MediaError.MEDIA_ERR_ABORTED:(0,a.Yi)("MEDIA_ERR_ABORTED");break;case MediaError.MEDIA_ERR_DECODE:this.retryError(e,n,4);break;case MediaError.MEDIA_ERR_NETWORK:(0,a.Yi)("MEDIA_ERR_NETWORK"),this.networkErrorProcedure.recover()&&e.preventDefault();break;case a.jc:this.retryError(e,n,1)}this.events$.next(e)}retryError(e,t,n){this.errorsCounter[t]++,this.errorsCounter[t]<=n?(e.preventDefault(),this.restart()):(0,a.Yi)(t)}getMimeTypeByUrl(e){const t=e.toLowerCase();return t.indexOf(".m3u8")>=5?"application/x-mpegURL":t.indexOf(".mpd")>=5?"application/dash+xml":t.endsWith(".mp4")?"video/mp4":((0,a.Yi)("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0442\u0438\u043f \u0432\u0438\u0434\u0435\u043e-\u0444\u0430\u0439\u043b\u0430 \u043f\u043e \u0435\u0433\u043e \u0441\u0441\u044b\u043b\u043a\u0435"),"video/*")}getType(e,t){const n=this.getMimeTypeByUrl(e),r={option:{transmission:{adaptiveStreaming:{bps:{start:void 0!==this.config.bps?this.config.bps:33e7}}}}};return this.drm&&(r.option.drm={type:this.drm.drmType,clientId:this.drm.clientId},"widevine"===this.drm.drmType&&(r.mediaTransportType="WIDEVINE")),t&&(r.option.transmission.playTime={start:1e3*t}),`${n};mediaOption=${(i=>{const e=(n,r)=>"object"==typeof r&&null!==r?(Object.keys(r).forEach(o=>{if(void 0===r[o])delete r[o];else{const d=e(o,r[o]);void 0!==d?r[o]=d:delete r[o]}}),0!==Object.keys(r).length?r:void 0):r,t=JSON.stringify(i,e);return void 0===t?"":encodeURIComponent(t)})(r)}`}applySourceAttributes(e,t){if(!e)return void(this.video.firstElementChild&&this.video.removeChild(this.video.firstElementChild));let n=this.video.firstElementChild;n||(n=document.createElement("source"),(0,v.R)(n,"error").pipe((0,N.Q)(this.destroy$)).subscribe(()=>{this.videoErrorListener((0,O.BB)({code:a.jc},this.video))}),this.video.appendChild(n)),n.setAttribute("src",e),n.setAttribute("type",t)}}},5454:(V,D,s)=>{s.d(D,{O:()=>p});var R=s(1985),b=s(8750);const{isArray:w}=Array;var y=s(4360);function p(...l){return 1===(l=function U(l){return 1===l.length&&w(l[0])?l[0]:l}(l)).length?(0,b.Tg)(l[0]):new R.c(function A(l){return g=>{let h=[];for(let m=0;h&&!g.closed&&m<l.length;m++)h.push((0,b.Tg)(l[m]).subscribe((0,y._)(g,C=>{if(h){for(let v=0;v<h.length;v++)v!==m&&h[v].unsubscribe();h=null}g.next(C)})))}}(l))}}}]);